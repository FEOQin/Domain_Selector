入了一台24刀年付的西雅图vps，重走一遍安全加固和代理搭建，即是记录，也是教程分享。

目录
本教程涉及：
本教程所使用的命令快捷复制网页
VPS到手安全加固
常用代理协议科普
3XUI节点搭建
通过3XUI实现代理链，使用你购买的固定住宅IP
通过WARP一键脚本+代理链免费解锁chatgpt、Netflix等流媒体
我这台VPS的融合怪测试结果。


正文：
本教程所使用的命令快捷复制网页
下载网址：
XXX.XXXX.com
下载下来是一个单html网页
你可以将你的VPS信息粘贴上去，直接复制整个命令，简化了编辑命令的流程


VPS到手安全加固

拿到手之后，首先要做的是从默认的账号密码登录，切换到秘钥登录。
相比起账号密码登录，密钥登录要安全的多，同时也方便的多。
为了方便从未使用过ssh工具的小白模仿，本贴使用powershell搭建。
我的系统是乌班图24
第一次登录命令：
ssh root@YOUR_SERVER_IP
第一次登录会提示`Are you sure you want to continue connecting (yes/no/[fingerprint])?`
输入`y`回车，然后输入`yes`即可。
接着会提示`root@YOUR_SERVER_IP's password:`
你可以直接复制密码。
然后右键粘贴。
注意：powershell中，右键就是粘贴。
并且在你粘贴密码后，不会显示密码，看起来就像没粘贴一样，实际上是粘贴了的！
粘贴好后回车
当你看到`root`开头，`~`结尾的一行，说明你已经进入了vps的控制界面。
看起来就像`root@XXXXXXX:~`

接下来我们要正式进行vps的安全加固

更新系统与基础加固
这是一个好习惯，能确保你的系统组件都是最新的，并添加一层自动防御。
更新软件包列表并升级已安装的软件包，一路回车就行
>sudo apt update && sudo apt upgrade -y

安装 Fail2Ban 自动防御
即使我们后续会改端口和用密钥，你的服务器依然会被各种机器人疯狂扫描。Fail2Ban可以自动拉黑这些恶意IP。
安装Fail2Ban
>sudo apt install fail2ban -y

检查 Fail2Ban 服务的当前状态
>sudo systemctl status fail2ban
看见一行带有绿色的`Loaded: loaded (/usr/lib/systemd/system/fail2ban.service; enabled; preset: enabled)`和绿色的`active (running)`就说明成功启动并设为开机自启了。
Ctrl+C退出，然后继续下一步。

如果没有看到绿色的active (running)，则运行以下命令，立即启动服务并设为开机自启。
>sudo systemctl start fail2ban && sudo systemctl enable fail2ban
然后可以再次使用前面的命令检查 Fail2Ban 服务的当前状态

继续使用ROOT用户名，但是改为高位端口。
从最佳实践上讲，应该放弃使用root用户名，并且将ssh登录端口改为高位。
root用户权限太高，非常危险，全世界的黑客都知道vps上有一个叫root的用户名，拥有最高的权限，ssh登录端口在22，因此肯定会优先攻击。
但是我实在是觉得每次干点啥都要输入sudo太麻烦了，我就不改了。
只将登录端口改到高位。

操作流程：

1.  生成密钥：在您自己的电脑上创建一对公钥和私钥。
2.  上传公钥：将公钥内容添加到服务器 `root` 用户的信任列表。
3.  测试密钥登录：确保在禁用密码前，密钥可以成功登录。
4.  终极加固：更改 SSH 端口、禁用密码登录、并配置防火墙。
5.  最终验证：使用新配置安全登录。

---

第 1 步：在本地电脑生成 SSH 密钥对

我选择使用 [PuTTYgen](https://www.puttygen.com/) 工具来生成密钥。

1.  打开 PuTTYgen。
    images\puttygen下载.png
2.  确保密钥类型为 “RSA”，强度至少为 2048 位。
    C:\Users\ccxkai\Documents\常用资料\VPS加固及代理搭建教程\images\puttygen.png
3.  点击 Generate 按钮，然后快速随意的移动鼠标，直到进度条走完（不移动鼠标进度条不走）。

操作完成后，请不要关闭 PuTTYgen 窗口。

*   公钥 (Public key)：复制顶部 `ssh-rsa` 开头的全部内容，我们马上要用到它。
*   私钥 (Private key)：稍后我们会将其保存到电脑上。

---

第 2 步：将公钥上传至服务器

现在，登录到服务器 `root` 账户，顺序执行以下命令：

1. 创建 .ssh 目录并设置严格的权限
mkdir -p /root/.ssh && chmod 700 /root/.ssh

 1. 使用 nano 编辑器打开 authorized_keys 文件
nano /root/.ssh/authorized_keys

1. 粘贴您的公钥
    将刚才从 PuTTYgen 复制的公钥内容右键粘贴到这个文件中。
    粘贴后，按 Ctrl+X，然后按 Y，最后按 Enter 保存并退出。

 2. 设置 authorized_keys 文件的严格权限（至关重要！）
chmod 600 /root/.ssh/authorized_keys

---

第 3 步：启用并测试密钥登录

在禁用密码登录之前，我们必须先测试密钥是否配置成功。

1.  修改 SSH 配置文件以确保允许密钥登录。
    nano /etc/ssh/sshd_config
    找到 `PubkeyAuthentication` 这一行，确保它没有被 `` 注释掉，并且值为 `yes`。
    PubkeyAuthentication yes
    修改后按 `Ctrl+X`, `Y`, `Enter`保存退出。

2.  重新加载 SSH 服务使配置生效。
    systemctl reload sshd
    使用 `reload` 可以平滑加载配置，不会中断您当前的连接。

3.  回到PuTTYgen上，点击菜单栏的 Conversions。
                    点击 Export OpenSSH key。
                    在弹出的窗口中保存文件。建议将文件命名为 id_rsa (不要加 .txt 或其他后缀)，并存放在一个您记得住的安全位置。
                    个人建议放在你用户名下的`.ssh`文件夹下,比如`C:\Users\ccxkai\.ssh`


4.  【密钥登录测试】
    不要关闭当前的 `root` 终端，另外打开一个新的 PowerShell 或终端窗口，使用以下命令尝试通过 密钥 登录 `root` 账户。

     将 "C:\Path\To\Your\PrivateKey" 和 YOUR_SERVER_IP 替换为您的实际信息
     注意：此时仍然使用默认端口 22
    ssh -i "C:\Path\To\Your\PrivateKey" root@YOUR_SERVER_IP
    确认成功登录后就可以将新的powershell窗口关闭了，我们继续在老窗口操作。

    重要：必须确保此步骤能成功登录！ 如果失败，请返回检查公钥内容和文件权限是否正确。只有成功后才能继续。

---

第 4 步：终极安全加固（改端口、禁密码、开防火墙）

回到原来的 `root` 终端窗口，我们进行最后的安全设置。

1.  一次性修改所有 SSH 安全配置。
    nano /etc/ssh/sshd_config
    进行以下三项关键修改：
    *   更改端口：找到 `Port 22`，去掉 `` 并将 `22` 改为一个不常用的端口（例如 `12345`）。
        Port 12345
    *   限制 Root 登录方式：找到 `PermitRootLogin` 一行，从`yes`修改为 `prohibit-password`。这表示 只允许 `root` 用户通过密钥登录，禁止密码方式。
        PermitRootLogin prohibit-password
    *   禁用密码登录：找到 `PasswordAuthentication`，确保其值被修改为 `no`。
        PasswordAuthentication no
    完成后保存退出 (`Ctrl+X`, `Y`, `Enter`)。

2.  按安全顺序开启防火墙并应用所有变更。
    ！！！极度重要！！！ 必须严格按照以下顺序操作，先放行新端口，再重启 SSH 服务，否则您将被锁在门外。

     1. (至关重要) 首先放行您的新 SSH 端口！
    ufw allow 12345/tcp   替换为您设置的新端口

     2. (可选) 如果您需要运行网站，放行 Web 服务端口
    ufw allow http
    ufw allow https

     3. 设置默认策略：拒绝所有传入连接
    ufw default deny incoming

     4. 启用防火墙
    ufw enable   执行时会提示确认，输入 y 并回车

     5. (最后一步) 重启 SSH 服务，让所有配置（新端口、禁用密码等）生效
    systemctl restart ssh

---

第 5 步：使用新方式登录

再次提醒：不要关闭当前的 `root` 终端！

另外打开一个新的 PowerShell 窗口，使用新端口、密钥和 `root` 用户 进行最终登录测试。

 将路径、IP 和新端口替换为最终信息
ssh -i "C:\Path\To\Your\PrivateKey" root@YOUR_SERVER_IP -p 12345

如果成功登录，恭喜您！您的服务器现在已经固若金汤。您可以安心地关闭所有旧的终端窗口了。

如果登录失败，请不要关闭原来的 `root` 终端。您可以利用它来检查 `/etc/ssh/sshd_config` 的配置和 `ufw status` 的防火墙状态，进行排错。
建议排查方法：可以在登录的powershell终端输入`sudo journalctl -u ssh -f`，然后在另一个终端尝试登录，将日志发给AI。


常用代理协议与GFW科普
下面简单讲一下GFW和常用代理协议，方便你理解后续要搭建的东西。
我们只讨论目前主流的、适合个人使用的几种。

GFW
全称：中国国家防火长城。
它横跨在每一个中国-国际网络出海口，所有从中国流出的流量都要被GFW审查。
除了GFW之外，一些省还有自己的“省墙”，这里就不展开了。

它是怎么工作的？主要有这么几种手段：

DNS污染
这是最常用的一招。当你访问 www.google.com 时，你的电脑需要先问DNS服务器：“google.com 的IP地址是多少？” GFW会抢在正确的DNS服务器之前，给你一个错误的、无效的IP地址。结果就是你的浏览器找不到网站，访问失败。

SNI阻断
这是一个非常精准的封锁技术。当你访问一个HTTPS网站时，在建立加密连接的最初阶段，你的浏览器需要用明文告诉服务器你想访问哪个域名（比如 www.example.com），这个明文信息就是SNI（服务器名称指示）。GFW会偷看这个SNI，如果发现域名在它的黑名单上，它会立刻切断连接，即使它不知道这个服务器的具体IP，也无法解密你们之间的通信内容。这就是为什么有时候一个IP上明明有很多网站，只有其中一个被墙了。

IP封锁
如果GFW知道了某个“不合适访问”网站的服务器IP地址，它会直接把这个IP地址拉进黑名单。所有发往这个IP地址的请求都会被直接丢弃，石沉大海。这就是为什么很多VPS的IP用着用着就“被墙”了。

深度包检测 (DPI)
这是最关键的技术。GFW会拆开你的网络数据包（即使是加密的），检查里面的内容特征。比如，它能识别出哪些流量看起来像是SS、VMess等代理协议的流量。一旦识别出来，它就可以进行干扰，比如让你的连接速度变得极慢，或者直接切断连接。这就是为什么代理协议需要不断更新换代，玩“伪装”和“加密”的游戏。

关键字过滤
GFW会检查流量中是否包含某些敏感词。如果发现，它可能会重置（切断）你当前的TCP连接，让你访问中断。

主动探测
GFW不仅仅是被动地监听，它还会主动出击。当GFW发现一个可疑的IP和端口（特别是像443这样的HTTPS端口）时，它会模仿一个普通浏览器，主动向这个地址发起一个标准的HTTPS连接请求。如果你的服务器是一个真正的网站，它会返回一个合法的TLS证书和网页内容。但如果你的服务器是一个简单的代理，无法正确回应这个“网站访问”请求，就会立刻暴露，GFW就会封锁这个IP。

看起来很厉害对吧，但是道高一尺魔高一丈，我们后续要做的所有代理搭建工作，本质上都是在想办法绕过GFW的这些检测，通过伪装和加密，让我们的流量在它看来是“无害的”，从而顺利地进出互联网。

Shadowsocks (简称SS)
这是最早期的代理协议之一，非常经典。
优点是原理简单，配置也简单，资源占用小，速度快。
缺点是流量特征比较明显，现在已经无法穿过GFW了，但它在我们之后配置代理链的时候将会大放异彩。

VMess
这是在SS基础上发展起来的第二代协议，功能强大了很多。
优点是引入了更复杂的加密和混淆，比SS更难被检测到。配置灵活，可以伪装成正常的网页流量。
缺点是现在也很容易被GFW识别，可能只有少数古早机场会用吧。

Trojan
这是一个非常聪明的协议，它的思路是“伪装”而不是“加密”。
Trojan把自己伪装成一个正常的HTTPS网站。当你访问时，GFW看来你就是在访问一个普通网站，无法分辨出这是代理流量。
优点是隐蔽性极高，非常难被封锁。
缺点是必须有一个域名，并且需要正确配置SSL证书，搭建过程比前两者要麻烦一点。

Xray (核心协议VLESS, XTLS)
可以看作是V2Ray的超集和性能优化版，由原V2Ray核心开发者开发。目前非常流行。
优点是性能极高，特别是在XTLS（也叫Vision）流控的加持下，能做到几乎零性能损耗的加密，延迟更低。功能上完全兼容V2Ray，并且有更多创新。
缺点和Trojan一样，需要域名和证书才能发挥最大威力，配置也比较复杂。
我们后面要用的3X-UI面板，就是基于Xray核心的。

Hysteria2
这是一个比较新的协议，主打“暴力美学”。
它不追求完美伪装，而是通过修改QUIC协议，在网络环境差（比如丢包严重）的情况下，通过多倍发包等方式强行保证速度和连接稳定性。
优点是在网络质量差的线路上效果拔群，速度比其他协议快很多。
缺点是会消耗更多的流量（因为它会重复发包），并且流量特征也比较独特，很容易被封端口。
虽然对于很多普通线路的vps来说，效果立竿见影，但说实话这个协议有种死道友不死贫道的感觉，因为它会让本就拥堵的国际线路更加拥堵。
ws（WebSocket 的缩写）
在我们的代理场景下，它不是一个独立的代理协议，而是一种伪装技术，或者叫“传输方式”。它被用来包装我们真正的代理数据（比如VLESS或VMess），让这些数据看起来像是正常的网页浏览流量。

Vision
这同样不是一个独立的协议，而是专属于VLESS协议的一种“流控模式”。可以把它理解成给VLESS协议装配的最高性能的引擎套件。
它的核心优势是实现了“零拷贝”或“近乎零拷贝”的数据转发。在传统的TLS加密中，数据需要多次在内存中复制，会造成性能损失和延迟。而Vision通过巧妙的设计，极大地减少了数据复制的次数，使得加密过程的性能损耗降到最低。
优点：性能极高，延迟极低。是目前VLESS协议追求极致性能时的不二之选。
缺点：无。

REALITY
这是近年来最重要、最具突破性的创新技术，它的出现改变了代理伪装的游戏规则。
REALITY的核心思路和Trojan一样，也是“伪装”，但它做得更彻底、更简单。
传统的伪装（如Trojan或VLESS+TLS+WS）需要你拥有一个自己的域名，并申请SSL证书，让你的服务器看起来像一个真正的网站。
而REALITY则完全不需要你拥有域名。它的原理是“借用”一个国际知名大厂的真实网站（比如 www.microsoft.com）的“身份”。当GFW主动探测你的服务器时，你的服务器会返回一个看起来就像是微软官网服务器的回应，从而完美地骗过探测。
优点：无需域名：省去了购买和维护域名的成本和麻烦。
隐蔽性极高：因为它借用的是真实、高信誉网站的身份，GFW极难将其与真正的网站流量区分开。
配置简单：相比需要配置Web服务器和证书的传统方案，REALITY的配置要简单得多。 
缺点：不能与CDN（如Cloudflare）一起使用，因为它的工作原理决定了流量必须直接到达你的服务器。

本来写了一大段3x-ui面板的教程，但是写完发现了一个叫s-ui的面板，貌似用的是sing-box核心，正好我也想搭建一个基于udp的代理。
就直接删掉前面写的，从头开始搭建s-ui。

安装s-ui面板
>bash <(curl -Ls https://raw.githubusercontent.com/alireza0/s-ui/master/install.sh)

安装时会询问你要不要更换端口和网页路径，以及自定义账号密码，一般选`n`即可。

完成后找到这一块
```
First admin credentials:
        Username:        admin     用户名
        Password:        admin     密码   
Created symlink /etc/systemd/system/multi-user.target.wants/s-ui.service → /etc/systemd/system/s-ui.service.
s-ui v1.2.2 installation finished, it is up and running now...
You may access the Panel with following URL(s):
Local address:
http://123.456.789.101:2095/app/    登录网址，但先不要登录。

```
注意看，登录网址是以`http://`开头的，说明目前是http协议，如果直接登录，账号、密码、网址都将暴露在明文下，任何一个传输你流量的中间人都会知道你访问的内容是什么，尤其是GFW。

因此我们要用一个安全的方法来登录。
常用方法有：
如果有域名，那么可以申请证书开启https，这样流量就会被加密，除了你和你的vps,没人知道你们传输了什么。
或者可以使用tunnel隧道传输，比如大善人cloudflare tunnel，http流量会被cloudflared加密，然后传输到cloudflare骨干网，由cloudflare进行https加密，更加安全。
如果没有域名的话，也可以使用SSH隧道，这也是本教程介绍的方法。

使用SSH隧道加密访问3xui面板
SSH是常用的加密协议，我们之前进行的所有命令行操作，都是经过SSH加密的。
首先，不要在已登录的SSH会话里执行这个命令。请在您的Windows电脑上，打开一个新的PowerShell窗口，然后执行以下命令：

ssh -o ServerAliveInterval=60 -L 本地端口:127.0.0.1:面板端口 用户名@服务器IP -p SSH端口 -i "私钥文件路径"

举例：
ssh -o ServerAliveInterval=60 -L 8080:127.0.0.1:2095 root@123.456.789.1011 -p 12345 -i "C:\Users\ccxkai\.ssh\XXX"

执行命令后，保持这个PowerShell窗口不要关闭。
然后打开你的浏览器，访问：
http://localhost:8080/app/   

C:\Users\ccxkai\Documents\常用资料\VPS加固及代理搭建教程\images\S-UI.png
看到这个页面，输入账号密码进入即可。

先点击`设置TLS`
C:\Users\ccxkai\Documents\常用资料\VPS加固及代理搭建教程\images\添加TLS.png







